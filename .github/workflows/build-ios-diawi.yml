name: Build iOS IPA and Deploy to Diawi

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      diawi_enabled:
        description: 'Upload to Diawi?'
        required: false
        default: 'true'

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build web assets
        run: npm run build

      - name: Sync Capacitor
        run: |
          echo "Running cap sync ios..."
          npx cap sync ios
          echo "cap sync completed"
          
      - name: Check for iOS build dependencies
        run: |
          echo "Checking Podfile..."
          if [ -f "ios/App/Podfile" ]; then
            echo "Podfile found, installing pods..."
            cd ios/App
            pod install
            cd ../..
          else
            echo "No Podfile found"
          fi

      - name: List iOS directory contents
        run: |
          echo "Contents of ios/App:"
          ls -laR ios/App/ || true
          echo ""
          echo "Looking for workspace or project file:"
          find ios/App -maxdepth 2 -name "*.xcworkspace" -o -name "*.xcodeproj"

      - name: Import signing certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.P12_PASSWORD }}
          keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}

      - name: Import provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/LoadrApp.mobileprovision

      - name: Verify provisioning profile
        run: |
          echo "Checking provisioning profiles..."
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/ || true
          echo ""
          echo "Checking keychain..."
          security find-identity -v -p codesigning
          
      - name: Build iOS app
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd ios/App
          
          # List available schemes
          echo "Available schemes:"
          xcodebuild -project App.xcodeproj -list
          
          echo ""
          echo "================================"
          echo "Attempting regular build first..."
          echo "================================"
          
          xcodebuild -project App.xcodeproj \
            -scheme App \
            -configuration Release \
            -derivedDataPath build \
            -resolvePackageDependencies \
            clean build 2>&1 | tee build.log
          
          BUILD_EXIT=$?
          echo "Build exited with code: $BUILD_EXIT"
          
          if [ $BUILD_EXIT -ne 0 ]; then
            echo "Build failed! Last 100 lines of log:"
            tail -100 build.log
            exit 1
          fi
          
          echo ""
          echo "================================"
          echo "Build succeeded, now archiving..."
          echo "================================"
          
          xcodebuild -project App.xcodeproj \
            -scheme App \
            -configuration Release \
            -derivedDataPath build \
            -archivePath build/App.xcarchive \
            -destination generic/platform=iOS \
            DEVELOPMENT_TEAM=$APPLE_TEAM_ID \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="LoadrApp" \
            SKIP_INSTALL=NO \
            -verbose \
            archive 2>&1 | tee archive.log
          
          ARCH_EXIT=$?
          echo "Archive exited with code: $ARCH_EXIT"
          
          if [ -d "build/App.xcarchive" ]; then
            echo "✓ Archive created successfully"
            ls -lah build/App.xcarchive
          else
            echo "✗ Archive not found"
            echo "Last 100 lines of archive log:"
            tail -100 archive.log
            exit 1
          fi

      - name: Create IPA
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd ios/App
          
          echo "Creating IPA from archive..."
          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist exportOptions.plist \
            -allowProvisioningUpdates \
            2>&1 | tee export.log
          
          EXPORT_EXIT=$?
          echo "Export exited with code: $EXPORT_EXIT"
          
          if [ -f "build/ipa/App.ipa" ]; then
            echo "✓ IPA created successfully"
            ls -lah build/ipa/App.ipa
          else
            echo "✗ IPA not found"
            echo "Last 50 lines of export log:"
            tail -50 export.log
            exit 1
          fi

      - name: Upload to Diawi
        if: github.event_name == 'push' || github.event.inputs.diawi_enabled == 'true'
        env:
          DIAWI_TOKEN: ${{ secrets.DIAWI_TOKEN }}
        run: |
          IPA_PATH="ios/App/build/ipa/App.ipa"
          
          if [ -f "$IPA_PATH" ]; then
            echo "Uploading IPA to Diawi..."
            curl -F "token=$DIAWI_TOKEN" \
              -F "file=@$IPA_PATH" \
              https://upload.diawi.com/
            echo ""
            echo "Upload complete!"
          else
            echo "IPA file not found at $IPA_PATH"
            exit 1
          fi

      - name: Upload IPA as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Loadr-IPA
          path: ios/App/build/ipa/App.ipa
          retention-days: 7

      - name: Clean up keychain
        if: always()
        run: |
          security delete-keychain build.keychain || true
